# Имя воркфлоу
name: Automated Branch Protector

# Запускать только вручную
on:
  workflow_dispatch:

jobs:
  protect-all-repositories:
    runs-on: ubuntu-latest
    steps:
      - name: Find Repos and Apply Protection
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
          GITHUB_USER: ${{ github.repository_owner }}
          # Правила защиты вынесены сюда, чтобы избежать ошибок синтаксиса в скрипте
          PROTECTION_RULES: |
            {
              "enforce_admins": true,
              "required_pull_request_reviews": {
                "required_approving_review_count": 1,
                "dismiss_stale_reviews": true
              },
              "required_status_checks": null,
              "restrictions": null,
              "allow_force_pushes": false,
              "allow_deletions": false
            }
        run: |
          # 1. Получаем список всех ваших репозиториев
          REPO_NAMES=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/users/$GITHUB_USER/repos?type=owner&per_page=100" | \
            jq -r '.[] | select(.archived==false and .name!=".github") | .name')

          echo "Найдено репозиториев для обработки:"
          echo "$REPO_NAMES"
          echo "-------------------------------------"

          # 2. Применяем защиту к каждому репозиторию
          for REPO in $REPO_NAMES; do
            echo "--- Обработка репозитория: $REPO ---"
            BRANCH_CHECK_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$GITHUB_USER/$REPO/branches/main")
            
            if [ "$BRANCH_CHECK_CODE" = "200" ]; then
              echo "Ветка 'main' найдена. Применяем защиту..."
              PROTECT_RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
                -H "Authorization: token $GITHUB_TOKEN" -d "$PROTECTION_RULES" \
                "https://api.github.com/repos/$GITHUB_USER/$REPO/branches/main/protection")
              
              if [ "$PROTECT_RESPONSE_CODE" = "200" ]; then
                echo "✅ УСПЕХ: Защита для '$REPO' успешно применена."
              else
                echo "❌ ОШИБКА: Код ответа GitHub: $PROTECT_RESPONSE_CODE для '$REPO'."
              fi
            else
              echo "➡️ ПРОПУСК: Ветка 'main' в '$REPO' не найдена."
            fi
          done
