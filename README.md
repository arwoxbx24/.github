# .github

# Передача проекта: Автоматизация зеркалирования репозиториев

Этот документ описывает текущее состояние автоматизации зеркалирования репозиториев, реализованной в GitHub Actions, включая возникшие проблемы и нерешенные вопросы.

## 1. Обзор автоматизации

Проект состоит из трех основных рабочих процессов (workflows) GitHub Actions, расположенных в репозитории `.github/.github/workflows/`:

*   `protect.yml`: Автоматическая защита веток.
*   `mirror-factory.yml`: Фабрика зеркалирования репозиториев в GitLab.
*   `bitbucket-mirror-factory.yml`: Фабрика зеркалирования репозиториев в Bitbucket (требует доработки).

## 2. `protect.yml` (Автоматическая защита веток)

*   **Назначение:** Ранее этот скрипт автоматически применял правила защиты ко всем веткам во всех репозиториях организации.
*   **Триггер:** Запускался по расписанию каждые 5 минут (`cron: '*/5 * * * *'`).
*   **Статус:** **ОТКЛЮЧЕН.**
*   **Что нужно знать:** Этот рабочий процесс был отключен. Теперь защита веток настраивается вручную. На данный момент защищена только ветка `main` во всех репозиториях организации. Правила защиты для `main`: 1 обязательный ревью, запрет force push и удаления.

## 3. `mirror-factory.yml` (Зеркалирование в GitLab)

*   **Назначение:** Автоматически создает и поддерживает зеркальные копии всех репозиториев GitHub в GitLab.
*   **Триггер:** Запускается по расписанию каждые 5 минут (`cron: '*/5 * * * *'`).
*   **Статус:** **Работает корректно.**
*   **Проблемы:**
    *   Те же задержки запуска со стороны GitHub, что и для `protect.yml`.
*   **Что нужно знать:**
    *   Использует секрет GitHub `GITLAB_PAT` для аутентификации с GitLab. Этот токен должен иметь права `api` в GitLab.
    *   Автоматически создает приватные репозитории на GitLab с суффиксом `-mirror` (например, `my-repo` -> `my-repo-mirror`).
    *   Поддерживает существующие зеркала в актуальном состоянии.

## 4. `bitbucket-mirror-factory.yml` (Зеркалирование в Bitbucket)

*   **Назначение:** Должен автоматически создавать и поддерживать зеркальные копии всех репозиториев GitHub в Bitbucket.
*   **Триггер:** Запускается по расписанию каждые 5 минут (`cron: '*/5 * * * *'`).
*   **Статус:** **НЕ РАБОТАЕТ.**
*   **Проблемы и нерешенные вопросы (требует доработки):**
    *   **Проблема с аутентификацией:** Скрипт не может авторизоваться в Bitbucket для Git-операций (клонирование/пуш).
        *   **Попытки решения:**
            *   Использовался "Пароль приложения" (App Password) с правами `Repositories: Read, Write, Admin`.
            *   Пробовали аутентификацию через `x-token-auth` в URL.
            *   Пробовали аутентификацию через SSH-ключи.
        *   **Результат:** Все попытки аутентификации завершились ошибкой `fatal: Authentication failed`.
        *   **Предполагаемая причина:** Либо сам 'Пароль приложения' создается некорректно (возможно, проблема с копированием или генерацией на стороне Bitbucket), либо Bitbucket имеет очень специфические требования к формату или типу токена для Git-операций через HTTPS/SSH.
    *   **Невозможность копирования SSH-ключа:** Пользователь не смог корректно скопировать публичный SSH-ключ из терминала для добавления в Bitbucket.
*   **Что нужно знать:**
    *   Использует секрет GitHub `BITBUCKET_PAT` (для API-вызовов создания репозитория) и должен использовать `BITBUCKET_SSH_KEY` (для Git-операций).
    *   Требует `BB_WORKSPACE` (arwox) и `BB_USERNAME` (arwox-admin) в переменных окружения.
    *   **Для запуска этого скрипта необходимо:**
        1.  **Решить проблему с аутентификацией Bitbucket.** Это может потребовать:
            *   Тщательной проверки процесса создания 'Пароля приложения' (App Password) и его прав.
            *   Обращения в службу поддержки Bitbucket для консультации по созданию рабочего токена для автоматизации Git-операций.
            *   Помощи другого разработчика, который сможет физически помочь с копированием SSH-ключа или настройкой Bitbucket.
        2.  **Убедиться, что `BITBUCKET_PAT` и `BITBUCKET_SSH_KEY` (если используется) корректно сохранены в секретах GitHub.**

## 5. Дальнейшие шаги

*   **Продолжить отладку `bitbucket-mirror-factory.yml`:** Основное внимание уделить проблеме аутентификации.
*   **Мониторинг:** Следить за запусками `protect.yml` и `mirror-factory.yml` в GitHub Actions, учитывая задержки планировщика.
